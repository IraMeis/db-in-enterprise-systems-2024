# Лабораторная работа №2  

### Задача машинного обучения  
Определяется пригодность воды для питья.
Идея простая - у measurement есть 9 параметров,
характеризующих содержание химических веществ в воде,
если все показатели соответствуют нормам, то вода
считается пригодной для питья (Potability 1), 
если хотя бы 1 параметр за пределами нормы - нет
(Potability 0).  

[jupyter notebook](https://github.com/IraMeis/db-in-enterprise-systems-2024/blob/main/lab2/lab2.ipynb)

**1. pH:**  
Кислотно–щелочной баланс воды. 
ВОЗ рекомендовала максимально допустимый уровень 
pH в диапазоне от 6,5 до 8,5.  

**2. Hardness / Жесткость:**  
Жесткость в основном обусловлена солями кальция и магния. 
ПДК – 500 мг/дм3.

**3. Solids / Твердые вещества 
(общее количество растворенных твердых веществ - TDS):**
Желаемый предел TDS составляет 500 мг/л, 
а максимальный предел - 1000 мг/л, 
который предписан для питьевых целей.

**4. Chloramines / Хлорамины:**  
Хлор и хлорамин являются основными дезинфицирующими
средствами, используемыми в системах общественного
водоснабжения. Содержание хлора в 
питьевой воде до 4 миллиграммов на литр 
считается безопасным.

**5. Sulfate / Сульфаты:**  
Содержание сульфатов 
в питьевой воде (норма) - 100-150 мг/дм3,
ПДК – 500 мг/дм3.

**6. Conductivity / Проводимость:**  
Как правило, количество растворенных в воде твердых веществ 
определяет электропроводность. Согласно стандартам 
ВОЗ, значение не должно превышать 400 МКС/см.

**7. Organic carbon / Органический углерод:**  
Органический углерод поступает 
из разлагающихся природных органических 
веществ, а также из синтетических источников. Согласно 
US EPA, содержание этой примеси в очищенной питьевой воде 
должно составлять < 2 мг/л, а в исходной воде, 
используемой для очистки, - < 4 мг/л.

**8. Trihalomethanes / Тригалометаны:**  
ТГМ - это химические вещества, которые могут 
содержаться в воде, обработанной хлором. 
Уровень ТГМ в питьевой воде до 80 
частей на миллион считается безопасным.

**9. Turbidity / Мутность:**  
Мутность воды зависит от количества твердых 
веществ, присутствующих во взвешенном состоянии. 
По рекомендации ВОЗ значение не более в 5,00 NTU.

**10. Potability / Пригодность для питья:**  
Указывает, безопасна ли вода для потребления 
человеком, где 1 означает пригодную для питья, 
а 0 - непригодную для питья.  

### Работа с данными  
Можно было бы использовать искусcтвенно полученные 
данные с бд (селект нужных столбцов +
проставить питоном Potability + импорт csv), 
но интереснее поработать с реальными данными.  
Датасет (data/water_potability.csv) взят с каггла.  

Вначале немного анализа данных -  
cмотрим распределение значений для столбцов
(dataframed.describe()), корреляцию,
находим столбцы с нулевыми занчениямим (ph,
Sulfate, Trihalomethanes). Заполняем пропущенные
значения средними (среденее высчитывается
отдельно для сторок с Potability=1 и Potability=0,
для ph также учитывается значение Hardness).
В датасете изначально количество записей
для классов 0 ~60% и 1 ~40%, оверсемплим при помощи
imblearn.over_sampling до соотношения 1:1.


### Oбучение и тест  

Подредактированный датасет делим на обучающую и 
тестовую выборку (80% и 20%).

```
X_train, X_test, y_train, y_test = train_test_split(X_res_over, y_res_over, test_size = 0.2, random_state = 42)
```

Выбранный классификатор - RandomForestClassifier.  
Сначала смотрим показатели на "базовой" модели,
без изменений в параметрах.

```
print(classification_report(y_test, base_pred, digits=4))

              precision    recall  f1-score   support

           0     0.8556    0.8122    0.8333       394
           1     0.8263    0.8670    0.8462       406

    accuracy                         0.8400       800
   macro avg     0.8410    0.8396    0.8397       800
weighted avg     0.8407    0.8400    0.8398       800
```
Подбираем гиперпараметры при помощи 
нескольких запусков RandomizedSearchCV (так быстрее,
чем перебирать все комбинации гридсерчем).  

**n_estimators** - число деревьев  
**max_features** - число признаков для выбора расщепления  
**min_samples_leaf** - минимальное число объектов в листьях  
**max_depth** - максимальная глубина деревьев  

Получаем параметры, обучаем итоговую модель.
Показатели не просели, но и улучшились не сильно.  
f1-score для 0: 0.8333 -> 0.8460  
f1-score для 1: 0.8462 -> 0.8490 

```
print(classification_report(y_test, model_pred, digits=4))

              precision    recall  f1-score   support

           0     0.8417    0.8503    0.8460       394
           1     0.8532    0.8448    0.8490       406

    accuracy                         0.8475       800
   macro avg     0.8475    0.8475    0.8475       800
weighted avg     0.8476    0.8475    0.8475       800
```